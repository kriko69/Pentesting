# introduccion a que es kerberos

Kerberos es un protocolo que permite a los usuarios autenticarse en la red y acceder a los servicios una vez autenticados. (en active directory)

Gracias a Kerberos, el usuario no necesitará escribir su contraseña cada vez y el servidor no necesitará conocer la contraseña de cada usuario. Esta es la autenticación centralizada.

el cliente debe autenticarse en el KDC (centro de distribución de claves que es un controlador de dominio en el entorno de Active Directory.)

Ticket-Granting Ticket (TGT): A continuación, debe solicitar un ticket para acceder al servicio elegido (por ejemplo, CIFS, HTTP, SQL,…).

finalmente usa el servicio al proporcionar el boleto.

## ANTES DE COMENZAR

**SPN**

Estamos en un entorno de Active Directory. Para comprender qué es un SPN, debemos comprender cuál es la noción de servicio dentro de un Active Directory.

Un servicio es en realidad una función, un software, algo que pueden utilizar otros miembros de AD (Active Directory). Puede tener, por ejemplo, un servidor web, un recurso compartido de red, un servicio DNS, un servicio de impresión, etc. Para identificar un servicio, necesitamos al menos dos cosas. El mismo servicio puede ejecutarse en diferentes hosts, por lo que debemos especificar el host , y una computadora puede albergar varios servicios, por lo que debemos especificar el servicio , obviamente.

EJ:

```
service_class/hostname_or_FQDN

www/SERVER12

www -> SERVICIO WEB
```

Si el servicio se ejecuta detrás de un puerto personalizado, o si desea especificarlo para evitar cualquier ambigüedad, puede agregarlo al nombre de host:

```
service_class/hostname_or_FQDN:port

www/SERVER12:80
```

Hay diferentes servicios, en elsiguiente liink loos nombran:

[https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc772815(v=ws.10)#service-principal-names](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc772815(v=ws.10)#service-principal-names)

script para enumerar los SPN mediante powershell

## Fase Servicio de autenticación (AS)

cuando un usuario quiere utilizar un servicio determinado. Para hacerlo, deberá autenticarse en el KDC y luego enviará una solicitud para utilizar el servicio.
Es lo que pasa en esta fase

Ej el usuario chris

**KRB_AS_REQ**

chris primero enviará una solicitud de un Ticket Granting Ticket (TGT) al controlador de dominio (DC). Esta solicitud se llama KRB_AS_REQ ( Solicitud de servicio de autenticación Kerberos ).

El TGT que solicita chris es una pieza de información cifrada que contiene, entre otras cosas, una clave de sesión e información del usuario (ID, nombre, grupos,…).

Para realizar esta solicitud TGT, chris enviará su nombre al KDC así como la hora exacta de la solicitud, cifrada con el hash de su contraseña.

El KDC recibirá este nombre de usuario y verificará que existe en su base de datos.

Si lo encuentra, recuperará el hash de chris que utilizará para intentar descifrar la marca de tiempo cifrada. Si no puede, entonces el cliente no usó la contraseña correcta para cifrar esta marca de tiempo.

Sin embargo, si lo hace, el KDC tiene la seguridad de que es realmente chris quien está hablando con él. Generará una clave de sesión única vinculada a este usuario y con limite de tiempo.

**KRB_AS_REP**

Es la respuesta del KDC,envia ciertas cosas:

* La clave de sesión, cifrada con el hash de chris (1)
* el TGT con la siguiente informacion:
    * Nombre de usuario (chris)
    * Período de validez
    * Clave de sesión generada (1) (misma clave)
    * El certificado de atributo de privilegio (PAC) que contiene mucha información específica sobre el usuario, incluido su identificador (SID) y todos los grupos a los que pertenece.

TGT se cifrará con la clave KDC. Por lo tanto, solo el KDC puede descifrar y leer el contenido de este ticket .

El cliente recibe estos datos. Usando su contraseña hash, la primera parte se descifrará para recuperar la clave de sesión que será necesaria para futuros intercambios. Pero no descifra el TGT.

## Servicio de concesión de tickets (TGS)
Ahora que el usuario está autenticado. El usuario tiene su propia clave así como una clave de sesión limitada en el tiempo que solo él conoce actualmente y un TGT cifrado con KDC que contiene, entre otras cosas, esta misma clave de sesión.

**KRB_TGS-REQ**

Si el usuario chris desea utiilizar el servicio CIFS en el servidor SERVER1, enviará varios datos al KDC (llamado KRB_TGS-REQ) para que él pueda devolver un ticket de servicio.

Enviara:

* El TGT
* El servicio que desea utilizar y el host asociado (CIFS/SERVER1)
* Un **autenticador**, que contiene su nombre de usuario y la marca de tiempo actual, todo cifrado con la clave de sesión.

El autenticador como su nombre dice ayudara en la autenticacin del lado de KDC.
Se envía para asegurarse de que Chris es el que realiza la solicitud. Para hacer esto, el KDC comparará el contenido del autenticador y el TGT. Dado que solo el KDC puede leer contenido TGT, no se pudo haber manipulado. El KDC leerá el contenido TGT, incluido la clave de sesión asociada (Ubicada dentro del TGT). Luego, descifrará el contenido del autenticador con esa clave de sesión. Si el descifrado funciona y los datos en el autenticador coinciden con los datos en el TGT, entonces Chris es quién dice ser. El KDC tiene la seguridad de que quien hizo la solicitud tiene el TGT y el conocimiento de la clave de sesión negociada.

**KRB_TGS_REP**

Ahora que el KDC ha podido verificar que el usuario es quien dice ser, enviará información que permitirá al usuario realizar una solicitud al servicio.

En el KRB_TGS_REP se envia la siguiente informacion:

* El nombre de usuario del usuario ( Chris)
* Un ticket (TGS) que contiene el nombre y el anfitrión del servicio solicitado ( CIFS/SERVER1), el nombre de usuario del usuario ( Chris), el PAC y una nueva clave de sesión que solo es válida para las comunicaciones entre Chris y SERVER1 por un cierto período de tiempo. Este ticket está encriptado con la clave del servicio (es decir, la clave del host, ya que el servicio CIFS se ejecuta bajo la cuenta del host)
* La nueva clave de sesión

Estos dos datos se cifran con la primera clave de sesión, la que se intercambió inicialmente entre el KDC y el cliente.

El cliente recibirá este mensaje y podrá descifrar la primera capa para obtener la clave de sesión creada para la comunicación con el servicio, así como el ticket generado para utilizar este servicio. Este ticket se denomina comúnmente Ticket-Granting-Service (TGS).

## Application Request (AP)

**KRB_AP_REQ**

Chris luego generará un nuevo autenticador que cifrará con esta nueva clave de sesión, junto con el TGS. Este es el mismo proceso que con el KDC.

CIFS (El servicio) recibe el TGS y puede descifrarlo con su clave del servicio. Dado que solo el servicio de DC conoce su clave, tiene la seguridad de que este TGS es auténtico. Este TGS contiene la clave de sesión que utilizará para descifrar el autenticador. Al comparar el TGS y el contenido del autenticador, el servicio puede estar seguro de la autenticidad del usuario.

Tras esto, si los permisos del usuario son correctos, este ya puede acceder al servicio. Para esto, si está configurado, el AP verificará contra el KDC el PAC. Y en caso de requerir autenticación mutua, responderá con un mensaje KRB_AP_REP al usuario.

# GOLDEN Y SILVER TICKETS

Ahora que ya sabemos como funciona kerberos empecemos

## PAC

PAC es una especie de extensión del protocolo Kerberos utilizado por Microsoft para la gestión adecuada de derechos en Active Directory. Hay mucha información sobre el usuario en su PAC, como su nombre, ID, pertenencia al grupo, información de seguridad, etc. El KDC es el único que realmente sabe todo sobre todos. Por tanto, es necesario que transmita esta información a los distintos servicios para que puedan crear tokens de seguridad adaptados a los usuarios que utilizan estos servicios.

El siguiente es un resumen de un PAC encontrado en un TGT. Se ha simplificado para que sea más fácil de entender.

```
AuthorizationData item
    ad-type: AD-Win2k-PAC (128)
        Type: Logon Info (1)
            PAC_LOGON_INFO: 01100800cccccccce001000000000000000002006a5c0818...
                Logon Time: Aug 17, 2018 16:25:05.992202600 Romance Daylight Time
                Logoff Time: Infinity (absolute time)
                PWD Last Set: Aug 16, 2018 14:13:10.300710200 Romance Daylight Time
                PWD Can Change: Aug 17, 2018 14:13:10.300710200 Romance Daylight Time
                PWD Must Change: Infinity (absolute time)
                Acct Name: Chris
                Full Name: Chris
                Logon Count: 7
                Bad PW Count: 2
                User RID: 1102
                Group RID: 513
                GROUP_MEMBERSHIP_ARRAY
                    Referent ID: 0x0002001c
                    Max Count: 2
                    GROUP_MEMBERSHIP:
                        Group RID: 1108
                        Attributes: 0x00000007
                            .... .... .... .... .... .... .... .1.. = Enabled: The enabled bit is SET
                            .... .... .... .... .... .... .... ..1. = Enabled By Default: The ENABLED_BY_DEFAULT bit is SET
                            .... .... .... .... .... .... .... ...1 = Mandatory: The MANDATORY bit is SET
                    GROUP_MEMBERSHIP:
                        Group RID: 513
                        Attributes: 0x00000007
                            .... .... .... .... .... .... .... .1.. = Enabled: The enabled bit is SET
                            .... .... .... .... .... .... .... ..1. = Enabled By Default: The ENABLED_BY_DEFAULT bit is SET
                            .... .... .... .... .... .... .... ...1 = Mandatory: The MANDATORY bit is SET
                User Flags: 0x00000020
                User Session Key: 00000000000000000000000000000000
                Server: DC2016
                Domain: WORKGROUP
                SID pointer:
                    Domain SID: S-1-5-21-3643611871-2386784019-710848469  (Domain SID)
                
```

Este PAC se encuentra en todos los tickets (TGT o TGS) y está encriptado con la clave KDC o con la clave de la cuenta de servicio solicitada. Por tanto el usuario no tiene control sobre esta información, por lo que no puede modificar sus propios derechos, grupos, etc.

Esta estructura es muy importante porque permite a un usuario acceder (o no acceder) a un servicio, un recurso, para realizar determinadas acciones.

El PAC se puede considerar como el distintivo de seguridad del usuario: puede utilizarlo para abrir puertas, pero no puede abrir puertas a las que no tiene acceso.

**SILVER TICKET**

Cuando un cliente necesita utilizar un servicio, solicita un TGS (Ticket Granting Service) al KDC. Este proceso pasa por dos solicitudes KRB_TGS_REQ y KRB_TGS_REP.

Está cifrado con el hash NT de la cuenta que ejecuta el servicio (cuenta de máquina o cuenta de usuario). Por lo tanto, si un atacante logra extraer la contraseña o el hash NT de una cuenta de servicio, puede falsificar un ticket de servicio (TGS) eligiendo la información que desea ingresar en él para acceder a ese servicio, sin preguntar al KDC. Es el atacante quien construye este ticket. Es este boleto falsificado que se llama Silver Ticket.



# ATAQUES A KERBEROS

## PASS THE KEY

## PASS THE TICKET

## GOLDEN AND SILVER TICKETS

## KERBEROASTING

## ASREPRoast

