# ESCALA DE PRIVILEGIOS MEDIANTE PATH HIJACKING

## EN QUE CONSISTE?

A partir de un archivo, preferentemente en algun lenguaje de programacion (bash, python, C, C++, java, php, ruby, perl) u otro tipo de archivo, ademas de que contenga permisos SUID, se debe determinar si ejecuta algun tipo de comando a nivel de sistema. (ls, mkdir, ifconfig, curl, cat, ps).

Normalmente un archivo de programcion ejecuta estas tareas. 

A nivel de sistema operativo tenemos una variables de entorno que son como variables globales del sistema que guarda algun tipo de informacion, las cuales por cada nuevo inicio de sesion se reestablecen a unas predeterminadas por el sistema, entonces se pueden agregar o modificar variables solo para el inicio de sesion.

(En caso de querer alterar la variable de entorno $PATH de manera permanente, puede editar el '/etc/environment' pero no es necesario para el ataque)

Cuando se ejecuta un comando por ejemplo: 'ps' tiene una ruta absoluta y otra relativa.

```
ps  --> ruta relativa

/usr/bin/ps  --> ruta absoluta
``` 

Cuando usas comando a traves de la ruta relativa, lo que hace es buscar en la variable de entorno $PATH el comando por las rutas declaradas en la variable $PATH.

$PATH vale esto:

```
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/home/christian/Android/Sdk:/home/christian/Android/Sdk/platforms:/home/christian/Android/Sdk/tools:/opt/gradle/5.0/bin:/usr/lib/jvm/java-8-openjdk/bin:/snap/bin
```

Como se ve hay varias rutas separadas por ':', la ruta relativa busca por estas rutas (de izquierda a derecha) el comando. Se puede ver la ruta '/usr/bin' en la variable $PATH por lo que el comando se ejecuta corectamente.

## ENCONTECES COMO ESCALAR

1. buscar archivos con permisos SUID

```
find \-perm -4000 2>/dev/null 

find \-perm -4000 -type f 2>/dev/null --> para filtrar solo archivos
```

2. Determinar un archivo raro que sea en algun lenguaje.

3. Buscar si se ejecuta algun comando.

```
strings nombre_archivo
```

Con strings podemos imprimir todas las cadenas imprimibles de un binario compilado.

4. Una vez determinado el comando nos dirigimos a una ruta con permisos de escritura como '/tmp' y creamos un archivo con el nombre del comando encontrado.

```
cd /tmp
touch comando
chmod +x comando
nano comando
agregamos 'bash -p'
```

Como el archivo encontrado ejecuta el comando y es SUID, con 'bash -p' abrimos una terminal y el parametro 'p' es una flag para abrirla como root.

5. Ahora el truco es hacer creer al sistema que ese archivo el que tiene que ejecutar, como ya dijimos al ejecutar un comando primero lo busca en la variable $PATH de izquierda a derecha, entonces agregaremos al comienzo la ruta donde creamos el archivo en este caso '/tmp'.

```
export PATH=/tmp:$PATH
```

Este cambio solo es temporal, si se cierra sesion y nuevamente se abre, no existira este cambio
Ahora buscara primero en /tmp y ahi es donde le decimos que el comando abrira una bash (terminal)

6. Nos dirigimos a la ruta donde esta el archivo SUID y lo ejecutamos. Al ejecutar deberia abrirnos una shell como Root.

## LIMITACIONES

El archivo debe contener una sentencia similar a esta:

```
setuid(0)  --> en C y python

```

Esto nos da una shell totalmente root, de lo contrario no hay seguridad en obtener la shell privilegiada.