# TAREAS CRON ESCALA DE PRIVILEGIOS

* Tarea Cron: Es una tarea que se ejecuta a intervalos reglares de tiempo. A nivel de sistema cada cierto minuto por ejemplo.

Para crear una tarea Cron, se lo debe crear en la reuta **'etc/cron.d'**

Cron es un sericio por lo que pdemos iniciarlo, detenerlo, ver su estado

```
service cron status
service cron start
service cron stop
```

creamos una tarea cron dentro de la ruta /etc/cron.d:

```
nano tarea
```

estructura de una tarea cron:

![Estructuras tarea Cron](cron.png)

Ejemplo:

```
* * * * * root /home/christian/Desktop/tarea.sh

los 5 asteriscos indican cada minuto
root es el usuario que quiero que lo ejecute
/home/christian/Desktop/tarea.sh es la ruta del file que quiero que se ejecute
```

Debemos crear el archivo que queremos que se ejecute:

```
en /home/christian/Desktop

touch tarea.sh
chmod +x tarea.sh --> permisos de ejecucion para la tarea
```

Es un script en bash (tarea.sh):

```
#!/bin/bash

# que espere 10 segundos
sleep 10

# que se elimine recursivamente todo lo que hay en la carpeta /tmp
rm -r /tmp/*   
```

**ESCALA DE PRIVILEGIOS**

El script 'deteccion_tareas_cron.sh' detecta las tareas cron que se ejecutan en el sistema, ahi podemos ver los ficheros .sh que se ejecutan. La idea es ver si en uno de esos tenemos el priilegio de escritura. En un entorno de CTF debemos ir a una ruta con permisos de escritura para crear este archivo. Por ejemplo /dev/shm.

Vemos la ruta de la tarea cron .sh y accedemos a ella para ver sus permisos. Si otros puede editarla y el propietario es root o tiene priilegios mas altos, es posible elevar privilegios editando ese archivo.

Debemos borrar el contenido de esa tarea.

Tenemos que agregar a la tarea cron:

```
chmod 4755 /bin/bash
```

Agregamos permisos SUID a la bash y esto se ejecutar como root en un determinado tiempo que tiene la tarea, entonces para spawnear una bash solo le damos desde nuestro usuario con bajos privilegios:

```
bash -p
```

con esoo se nos abre una bash como root o es usuario propietario. Se debe colocar la opcion '-p' para que funcione la escalada de privilegios.

Si detectamos una tarea cron en php, py, ruby, perl, java, etc.
Debemos ver la forma de ejecutar el comando 'chmod 4755 /bin/bash' con la sintaxis del lenguaje.

pueden usar la herramienta pspy para hacer la deteccion de tareas cron cn el id del usuario que la ejecuta, asi puede saber si es el usuario root quien lo hace. (id=0)

[https://github.com/DominicBreuker/pspy](https://github.com/DominicBreuker/pspy)

damos permisos de ejecucin y ejecutamos:

```
chmod +x pspy64

./pspy64 -pf -i 1000  --> monitoreo de acciones cada 1 segundo

solo ve las tareas que ejecutan un archivo alojado en: /etc /usr /tmp /home /var /opt
pero se puede modificar
```