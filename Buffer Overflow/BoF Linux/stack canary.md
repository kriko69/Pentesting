# Stack canary Bypass

## introducción

El stack canary o tambien conocido como stack cookie, stack protector, stack guard o SSP es un valor de 4 bytes que se insertapor debajo del EIP. Cuando la función termina su tarea, y el stack frame se borra, el valor de la cookie de la pila es comparado con el valor previamente introducido. Si es diferente, el programa se termina llamando a la función **__stack_chk_fail**. 

En algun lugar se la memoria se guarda el valor del stack canary para compararlo cada que se termina una funcion del programa, cuando nosotros desbordamos el buffer, sobreescribimos el stack canary por lo que a la hora de la comparacion esto falla al no ser iguales.

## Tipos de stack canary

El staack canary puede ser de uno de los siguientes tipos:

* **Canario aleatorio:** es un valor de 4 bytes generado por p. Ej. /dev/random.
* **Random XOR Canary:** es aquel que crea un canario aleatoriamente, pero también utiliza un algoritmo que analiza las partes de control de la pila. Una parte de control de la pila es la dirección de retorno en el puntero del marco. Entonces, si un atacante intenta cambiar cualquier parte de estos elementos de control de la pila como normalmente pretenden, entonces el atacante también tiene que cambiar el canario.
* **Canario nulo:** el canario tiene un valor de 0x00000000; supuestamente, será imposible entregar ceros a la stack, ya que es un terminador nulo para cadenas. Es lo mas facil de implementar pero tambien facil de reconocer y evadir.
* **Terminator canary:** el canario se establece en una combinación de terminadores de cadena como 0x00, 0xff, 0x0a y 0x0d.
* **Custom canary:** es un canary personalizado que puede tener una dirección especifica. Pero probablemente no sean más efectivos.

## signos de que se esta utilizando una stack canary

* Se muestra el mensaje **“Stack smashing detected”** en un intento de desbordamiento del buffer.
* Se ve llamadas  al **"__stack_chk_fail" o funciones similares** cuando de realiza un disassembler del codigo.

## Compilacion del binario

Para activart el stack canary se debe compilar con el siguiente parametro en el gcc:

```
-fstack-protector-all
```

## Técnicas comunes de bypass stack canary

* Fuerza bruta al stack canary. (Como con el ASRL)
* Fuga de informacion. (Leak con ret2write o format string)

## Funcionamiento

La idea es filtrar de alguna manera la direccion del stack canary y agregarlo manualmente a nuestro exploit en la posicion donde debe ir (rellenando lo demas con un padding puede ser de 'A'). Despues de esto puedes sobreescribir el EIP o RIP como normalmente se lo hace y de esta foma no saldra la advertencia cuando se llama a la funcion __stack_chk_fail.




